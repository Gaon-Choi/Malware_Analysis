import json
from tqdm import tqdm
import os
from collections import defaultdict

with open('./progress.json', 'r', encoding='utf-8') as f:
    progress = json.load(f)

progress['success'] = list(dict.fromkeys(progress['success']))
progress['todo'] = list(dict.fromkeys(progress['todo']))

print(len(progress['success']), len(progress['todo']))

new_success = []
new_todo = []

md5_error = 0
errored = []
correct = []

check_files = ['base', 'dropped_files', 'behaviours', 'contacted_domains', 'contacted_ips', 'contacted_urls']
for i in tqdm(progress['success']):
    is_error = False
    if os.path.exists(f'./fetch_result/{i}/empty'):
        new_success.append(i)
        continue
    for file in check_files:
        try:
            path = f'./fetch_result/{i}/{file}.json'
                
            with open(path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            if 'error' in data:
                is_error = True
                break
            if file == 'base':
                errored.append(data['data']['attributes']['md5'])
                correct.append(i)
                if data['data']['attributes']['md5'] != i:
                    is_error = True
                    md5_error += 1
                    break
        except Exception as e:
            print(e)
            is_error = True
            break
    if is_error:
        new_todo.append(i)
    else:
        new_success.append(i)

progress['todo'] = new_todo + progress['todo'] + progress['failure']
progress['success'] = new_success
progress['failure'] = []
print(f'md5 error: {md5_error}')
print(len(progress['todo']), len(progress['success']))

# C = set(errored) & set(correct)
# print(len(list(set(errored))), len(list(set(correct))), len(C))
with open('./progress.json', 'w', encoding='utf-8') as f:
    json.dump(progress, f)