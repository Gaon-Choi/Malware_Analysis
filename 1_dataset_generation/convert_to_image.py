import subprocess
import numpy
import imageio
import os
import array
import glob

number_of_samples = 500

def is_vir(input_file):
    ext = os.path.splitext(os.path.basename(input_file))[1]
    print('ext = ', ext)
    result = False
    if '.vir' == ext:
        result = True
    return result

def generate_and_save_image(input_dir, output_dir, filename):

    #변환 후 저장할 파일 path (path + filename + png)
    out_file = os.path.splitext(os.path.basename(filename))[0] + '.png'
    out_file_full = output_dir + out_file
    input_file_path = os.path.join(input_dir, filename)
    print("out_file_full: ", out_file_full)
    if is_vir(filename):
        f = open(input_file_path, 'rb')
        ln = os.path.getsize(input_file_path)  # length of file in bytes
        width = 32
        rem = ln % width

        a = array.array("B")
        a.fromfile(f, ln - rem)

        f.close()
        g = numpy.reshape(a, (len(a) // width, width))
        g = numpy.uint8(g)

        #save image
        imageio.imwrite(out_file_full, g)

    else:
        print("not .vir")



def convert_bin_to_img(input_dir, output_dir):
    if not os.path.isdir(input_dir):
        print(input_dir, 'Input directory not found. Exiting.')
        exit(0)
    if not os.path.isdir(output_dir):
        os.mkdir(output_dir)
    count = 0
    files = os.listdir(input_dir)
    print(len(files))
    for filename in files:
        print("filename: ", filename)

        generate_and_save_image(input_dir, output_dir, filename)
        print(filename)
        count += 1
        print(count)
        if number_of_samples == count:
            exit(0)

convert_bin_to_img("../Data/benign500", "../Data/benign_500_img/")