import os
import json
import shutil
from collections import ChainMap
json_location = "C:/Users/USER/Documents/카카오톡 받은 파일/fetch_result/"
ff = 'train'
categories = set()
files = os.listdir("D:/바탕화면/파일/4학년 1학기/컴퓨터소프트웨어캡스톤PBL(인공지능기반악성코드분석)/dataset_resized_images/{folder}/malware/".format(folder=ff))
file_error = 0
index_error = 0
element = 0

for filename in files:
    a, b = filename.split('.')
    # print(a)
    json_loc = json_location + a + '/base.json'
    try:
        with open(json_loc, mode='r', errors='ignore') as inp:
            dict_from_json = json.load(inp)
        category_lists = dict_from_json['data']['attributes']['popular_threat_classification']['popular_threat_category']
        print(category_lists)
    except FileNotFoundError:
        # print("FileNotFoundError", filename)
        file_error += 1
    except KeyError:
        print("KeyError", filename)
        index_error += 1
    else:
        element += 1
        # print(category_lists)
        maxima = -1000000
        category = str()
        print(category_lists)

        category_tuples = [(c['count'], c['value']) for c in category_lists]
        category_tuples = sorted(category_tuples, reverse=True)

        maxima, category = category_tuples[1] if category_tuples[0][1] == 'trojan' and len(category_tuples) >= 2 else category_tuples[0]
        # exit(0)
        # for elem in category_lists:
        #     # print(elem)
        #     if elem['count'] >= maxima:
        #         maxima = elem['count']
        #         category = elem['value']
        # print(category)
        categories.add(category)
        src = "D:/바탕화면/파일/4학년 1학기/컴퓨터소프트웨어캡스톤PBL(인공지능기반악성코드분석)/dataset_resized_images/{folder}/malware/".format(folder=ff)
        dest1 = "C:/Users/USER/Documents/malware_project/dataset/" + category + "/"
        # print(src+filename)
        # print(dest1+filename)
        shutil.move(src + filename, dest1 + filename)

    # print(dict_from_json['popular_threat_category'])
print(categories)
print(file_error, index_error, element)